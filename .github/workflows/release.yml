name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tag version to release"
        required: true
        type: string
  push:
    paths-ignore:
      - "docs/**"
      - "README.md"
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: subcon
  CROSS_VERSION: v0.2.5
  RUST_BACKTRACE: 1

jobs:
  create-release:
    name: create-release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            v="${{ github.event.inputs.version }}"
          else
            v="${{ github.ref_name }}"
          fi

          if [[ -z "$v" ]]; then
            echo "version is empty" >&2
            exit 1
          fi

          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "VERSION=$v" >> "$GITHUB_ENV"

      - name: Create GitHub release (draft)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh release create "$VERSION" \
            --draft \
            --verify-tag \
            --title "$VERSION"

  build-binaries:
    name: build-binaries (${{ matrix.target }})
    needs: [create-release]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (glibc)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: true
            ext: ""
            static: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: true
            ext: ""
            static: false
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-gnu
            use_cross: true
            ext: ""
            static: false

          # Linux (musl, prefer static)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_cross: true
            ext: ""
            static: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            use_cross: true
            ext: ""
            static: true
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-musl
            use_cross: true
            ext: ""
            static: true

          # macOS
          - os: macos-latest
            target: x86_64-apple-darwin
            use_cross: false
            ext: ""
            static: false
          - os: macos-latest
            target: aarch64-apple-darwin
            use_cross: false
            ext: ""
            static: false

          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
            ext: ".exe"
            static: false
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            use_cross: false
            ext: ".exe"
            static: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Install cross
        if: matrix.os == 'ubuntu-latest' && matrix.use_cross
        shell: bash
        run: |
          dir="$RUNNER_TEMP/cross"
          mkdir -p "$dir"
          echo "$dir" >> "$GITHUB_PATH"
          cd "$dir"
          curl -LO "https://github.com/cross-rs/cross/releases/download/${CROSS_VERSION}/cross-x86_64-unknown-linux-musl.tar.gz"
          tar xf cross-x86_64-unknown-linux-musl.tar.gz
          echo "CARGO=cross" >> "$GITHUB_ENV"

      - name: Configure cross image (riscv64 musl)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'riscv64gc-unknown-linux-musl'
        shell: bash
        run: |
          cat > Cross.toml <<'EOF'
          [target.riscv64gc-unknown-linux-musl]
          image = "ghcr.io/cross-rs/riscv64gc-unknown-linux-musl:main"
          EOF

      - name: Build (release)
        shell: bash
        run: |
          # Prefer fully static binaries on Linux-musl for maximum compatibility.
          if [[ "${{ matrix.static }}" == "true" ]]; then
            export RUSTFLAGS="${RUSTFLAGS:-} -C target-feature=+crt-static"
          fi

          cargo_cmd="${CARGO:-cargo}"
          $cargo_cmd build --release --target "${{ matrix.target }}"

          bin="target/${{ matrix.target }}/release/${APP_NAME}${{ matrix.ext }}"
          if [[ ! -f "$bin" ]]; then
            echo "binary not found: $bin" >&2
            ls -la "target/${{ matrix.target }}/release" || true
            exit 1
          fi

          echo "BIN=$bin" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: bash
        run: |
          version="${{ needs.create-release.outputs.version }}"
          out="${APP_NAME}-${version}-${{ matrix.target }}.zip"
          pkg_dir="${APP_NAME}"
          rm -rf "$pkg_dir"
          mkdir -p "$pkg_dir"
          cp "$BIN" "$pkg_dir/${APP_NAME}${{ matrix.ext }}"
          cp -R "example/conf" "$pkg_dir/conf"
          cp -R "schema" "$pkg_dir/schema"
          7z a "$out" "$pkg_dir"
          echo "ASSET=$out" >> "$GITHUB_ENV"

      - name: Package (Unix)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          version="${{ needs.create-release.outputs.version }}"
          out="${APP_NAME}-${version}-${{ matrix.target }}.tar.gz"
          pkg_dir="${APP_NAME}"
          rm -rf "$pkg_dir"
          mkdir -p "$pkg_dir"
          cp "$BIN" "$pkg_dir/${APP_NAME}${{ matrix.ext }}"
          cp -R "example/conf" "$pkg_dir/conf"
          cp -R "schema" "$pkg_dir/schema"
          tar czf "$out" "$pkg_dir"
          echo "ASSET=$out" >> "$GITHUB_ENV"

      - name: Upload to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ needs.create-release.outputs.version }}"
          gh release upload "$version" "$ASSET"

  build-deb:
    name: build-deb (${{ matrix.target }})
    needs: [create-release]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
          - target: aarch64-unknown-linux-gnu
          - target: riscv64gc-unknown-linux-gnu
    env:
      TARGET: ${{ matrix.target }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          target: ${{ env.TARGET }}

      - name: Install cross
        shell: bash
        run: |
          dir="$RUNNER_TEMP/cross"
          mkdir -p "$dir"
          echo "$dir" >> "$GITHUB_PATH"
          cd "$dir"
          curl -LO "https://github.com/cross-rs/cross/releases/download/${CROSS_VERSION}/cross-x86_64-unknown-linux-musl.tar.gz"
          tar xf cross-x86_64-unknown-linux-musl.tar.gz
          echo "CARGO=cross" >> "$GITHUB_ENV"

      - name: Build binary (release)
        shell: bash
        run: |
          cargo_cmd="${CARGO:-cargo}"
          $cargo_cmd build --release --target "${TARGET}"

          bin="target/${TARGET}/release/${APP_NAME}"
          if [[ ! -f "$bin" ]]; then
            echo "binary not found: $bin" >&2
            ls -la "target/${TARGET}/release" || true
            exit 1
          fi

      - name: Install cargo-deb
        shell: bash
        run: |
          cargo install cargo-deb --locked

      - name: Build .deb
        shell: bash
        run: |
          version="${{ needs.create-release.outputs.version }}"
          deb_version="${version#v}"

          cargo deb \
            --target "${TARGET}" \
            --no-build \
            --no-strip \
            --deb-version "${deb_version}-1"

          deb_file="$(ls -t target/debian/*.deb | head -n 1)"
          if [[ -z "$deb_file" || ! -f "$deb_file" ]]; then
            echo "no .deb found in target/debian" >&2
            ls -la target/debian || true
            find target -maxdepth 3 -type f -name "*.deb" -print || true
            exit 1
          fi

          echo "DEB_FILE=$deb_file" >> "$GITHUB_ENV"

      - name: Upload .deb to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          version="${{ needs.create-release.outputs.version }}"
          gh release upload "$version" "$DEB_FILE"
